# JSON Validation Tool

Custom MCP tool for validating `lesson_template.json` OUTPUT schema against Pydantic models with detailed error reporting.

**Version**: 2.0.0 (Complete rewrite with deep validation)

## Overview

The JSON Validation Tool provides **fast-fail validation** with detailed error messages before files reach the upserter, preventing silent failures and enabling agent self-correction.

**CRITICAL**: This validates the **lesson_template.json OUTPUT schema** (generated by lesson_author agent), NOT the SOW input schema.

## Purpose

- ✅ **Catch errors early**: Validate JSON structure immediately after writing
- ✅ **Detailed feedback**: Field-level error messages with fix suggestions
- ✅ **Enable self-correction**: Agents can parse errors and autonomously fix issues
- ✅ **Prevent silent failures**: Explicit errors instead of fallback patterns
- ✅ **Save tokens**: Avoid critic evaluation of structurally invalid files
- ✅ **Deep validation**: Type-specific CFU validation, rubric validation, misconception validation

## Architecture

### Components (v2.0.0)

1. **Pydantic Models** (`src/tools/json_validator_tool.py`):
   - **Base Models**:
     - `Rubric`: Rubric structure with criteria validation
     - `RubricCriterion`: Individual criterion with points validation
     - `Misconception`: Misconception ID format and content validation
   - **CFU Type-Specific Models** (deep validation):
     - `CFU_MCQ`: Multiple choice with answerIndex, options, rubric
     - `CFU_Numeric`: Numeric answer with expected, tolerance, money2dp
     - `CFU_StructuredResponse`: Written response with rubric
     - `CFU_ShortText`: Brief response with rubric
   - **Card and Template Models**:
     - `LessonTemplateCard`: Card validation with OUTPUT schema fields
     - `LessonTemplate`: Top-level template validation
   - **Custom validators**: Enums, constraints, business rules, cross-field validation

2. **MCP Server** (`lesson-validator`):
   - In-process custom tool server
   - Tool name: `mcp__validator__validate_lesson_template`

3. **Integration Points**:
   - `lesson_author` subagent: Validates AFTER writing `lesson_template.json` (Step 4.5)
   - `combined_lesson_critic` subagent: Validates BEFORE quality evaluation (Step 0)

## Usage

### In Agent Prompts

```markdown
After writing lesson_template.json:

1. Call validation tool:
   Tool: mcp__validator__validate_lesson_template
   Args: {"file_path": "lesson_template.json"}

2. Check result:
   - If is_valid: true → Proceed to next step
   - If is_valid: false → Fix errors and re-validate
```

### Response Formats

#### Success Response

```json
{
  "is_valid": true,
  "message": "✅ Validation passed",
  "details": {
    "title": "Calculating Fractions of Amounts",
    "card_count": 4,
    "lesson_type": "teach",
    "courseId": "course_c84874",
    "sow_order": 3
  }
}
```

#### JSON Syntax Error

```json
{
  "is_valid": false,
  "error_type": "JSON_SYNTAX_ERROR",
  "message": "Invalid JSON syntax at line 288, column 61",
  "details": {
    "error": "Expecting ',' delimiter",
    "position": "line 288, column 61",
    "char_position": 19188
  },
  "fix_suggestions": [
    "Check for missing commas between fields",
    "Remove any inline comments (JSON doesn't support comments)",
    "Ensure all strings are properly quoted",
    "Check for trailing commas (not allowed in JSON)",
    "Validate JSON structure with a JSON linter"
  ]
}
```

#### Schema Validation Error

```json
{
  "is_valid": false,
  "error_type": "SCHEMA_VALIDATION_ERROR",
  "message": "Found 3 validation error(s)",
  "errors": [
    {
      "field": "courseId",
      "error": "courseId must start with 'course_'",
      "type": "value_error",
      "input_value": "invalid_format"
    },
    {
      "field": "lesson_type",
      "error": "value is not a valid enumeration member; permitted: 'teach', 'independent_practice', 'formative_assessment', 'revision', 'mock_exam'",
      "type": "type_error.enum",
      "input_value": "introduction"
    },
    {
      "field": "cards",
      "error": "lesson_type 'teach' requires 3-4 cards, got 5",
      "type": "value_error",
      "input_value": null
    }
  ],
  "fix_suggestions": [
    "Check that all required fields are present",
    "Verify enum values (lesson_type, card_type, cfu_type, status)",
    "Ensure card count matches lesson_type requirements",
    "Validate courseId format (must start with 'course_')",
    "Check that outcomeRefs is not empty",
    "Ensure card_number values are sequential starting from 1"
  ]
}
```

#### File Not Found Error

```json
{
  "is_valid": false,
  "error_type": "FILE_NOT_FOUND",
  "message": "File not found: lesson_template.json",
  "details": {
    "file_path": "lesson_template.json",
    "absolute_path": "/workspace/lesson_template.json"
  },
  "fix_suggestions": [
    "Check that the file path is correct",
    "Ensure the file has been written before validation",
    "Verify you're in the correct working directory"
  ]
}
```

## Validation Rules (v2.0.0)

### Template-Level Required Fields

- `courseId`: Must start with "course_" (regex: `^course_[a-zA-Z0-9]+$`)
- `title` OR `label`: At least one must be provided (**30-80 characters**)
- `outcomeRefs`: Non-empty array of strings (SQA outcome codes)
- `lesson_type`: Enum value (see below)
- `estMinutes`: Integer between 30 and 120
- `sow_order`: Integer >= 1
- `cards`: Non-empty array of LessonTemplateCard objects

### Lesson Type Enum

Valid values:
- `teach`
- `independent_practice`
- `formative_assessment`
- `revision`
- `mock_exam`

### Card Count Validation

**Universal Bounds**:
- Minimum: 1 card (focused single activity)
- Maximum: 20 cards (practical limit for token constraints and session length)

**Pedagogical Guidance** (not enforced by validator):
- Align with SOW card_structure count when provided (preferred)
- Consider estMinutes: typically 10-15 minutes per card
- Lesson type influences pedagogy, not card count (e.g., "teach" uses scaffolding patterns, not fixed count)

**Validation**: Only checks universal bounds (1-20) and sequential card IDs.
**Quality Evaluation**: Critic evaluates pedagogical coherence and SOW fidelity.

### Card-Level Required Fields (OUTPUT Schema)

**IMPORTANT**: Cards in the OUTPUT schema use different fields than SOW input schema.

Required fields for each card:
- `id`: Sequential card ID (regex: `^card_\d{3}$`) - Examples: `card_001`, `card_002`, `card_003`
- `title`: Card title (10-150 characters)
- `explainer`: Detailed explanation (min 50 characters)
- `explainer_plain`: Simplified explanation (min 30 characters)
- `cfu`: CFU object (see CFU validation below)
- `rubric`: Rubric object (see Rubric validation below)
- `misconceptions`: Array of misconception objects (min 1 item, see Misconception validation below)

Optional fields:
- `context_hooks`: Array of Scottish context tags

### Card ID Validation

- Must be sequential: `card_001`, `card_002`, `card_003`, etc.
- No gaps or duplicates
- Format: `card_` followed by 3-digit zero-padded number
- Example: `["card_001", "card_002", "card_003"]` ✅
- Example: `["card_001", "card_003", "card_004"]` ❌ (gap at card_002)
- Example: `["card_001", "card_002", "card_002"]` ❌ (duplicate)

### CFU Type Enum

**CRITICAL**: CFU objects use `type` field (NOT `cfu_type`).

Valid CFU types:
- `mcq` (multiple choice question)
- `numeric` (numeric answer)
- `structured_response` (extended written answer)
- `short_text` (brief written response)

### CFU Type-Specific Validation (NEW in v2.0.0)

#### MCQ (`type: "mcq"`)
Required fields:
- `type`: "mcq"
- `id`: Unique question ID
- `stem`: Question text
- `options`: Array of 3-5 strings
- `answerIndex`: Integer (0-based index into options array, must be < len(options))
- `rubric`: Rubric object

#### Numeric (`type: "numeric"`)
Required fields:
- `type`: "numeric"
- `id`: Unique question ID
- `stem`: Question text
- `expected`: Expected numeric answer (float)
- `tolerance`: Acceptable deviation (float >= 0)
- `money2dp`: Boolean (true if currency with 2 decimal places)
- `rubric`: Rubric object

Optional fields:
- `hints`: Array of 3-5 hint strings

#### Structured Response (`type: "structured_response"`)
Required fields:
- `type`: "structured_response"
- `id`: Unique question ID
- `stem`: Question/prompt text
- `rubric`: Rubric object (used for marking guidance)

#### Short Text (`type: "short_text"`)
Required fields:
- `type`: "short_text"
- `id`: Unique question ID
- `stem`: Question/prompt text
- `rubric`: Rubric object

### Rubric Validation (NEW in v2.0.0)

Required fields:
- `total_points`: Total points available (float > 0)
- `criteria`: Array of RubricCriterion objects (min 1 item)

Each criterion requires:
- `description`: Criterion description (10-500 characters)
- `points`: Points for this criterion (float > 0)

**Validation Rule**: Sum of all criteria points MUST equal `total_points`.

Example:
```json
{
  "total_points": 3,
  "criteria": [
    {"description": "Correct answer", "points": 1},
    {"description": "Shows working", "points": 1},
    {"description": "Uses units", "points": 1}
  ]
}
```

### Misconception Validation (NEW in v2.0.0)

Required fields:
- `id`: Misconception ID (regex: `^MISC_[A-Z]+_[A-Z_]+_\d{3}$`)
  - Format: `MISC_SUBJECT_TOPIC_XXX`
  - Example: `MISC_MATHS_FRACTIONS_001`
- `misconception`: Description of the misconception (10-200 characters)
- `clarification`: Explanation to address the misconception (20-500 characters)

### Status Enum (Optional)

Valid status values:
- `draft` (default)
- `review`
- `published`

## Common Errors

### 1. JSON Inline Comments

**Problem**: JSON doesn't support comments

```json
"sample_weak_response": "Text here" [This is a comment]
```

**Error**:
```
JSON_SYNTAX_ERROR at line X, column Y: Expecting ',' delimiter
```

**Fix**: Remove inline comments
```json
"sample_weak_response": "Text here"
```

---

### 2. Invalid Enum Values

**Problem**: Using invalid `lesson_type`

```json
"lesson_type": "introduction"
```

**Error**:
```
field: "lesson_type"
error: "value is not a valid enumeration member; permitted: 'teach', 'independent_practice', 'formative_assessment', 'revision', 'mock_exam'"
```

**Fix**: Use valid enum
```json
"lesson_type": "teach"
```

---

### 3. Card Count Out of Bounds

**Problem**: Card count exceeds universal limits

```json
"lesson_type": "mock_exam",
"cards": [...]  // 25 cards (exceeds maximum)
```

**Error**:
```
field: "cards"
error: "Lesson must have 1-20 cards, got 25. Create as many cards as needed based on pedagogical requirements and estMinutes."
```

**Fix**: Consolidate cards or split into multiple lessons
```json
"lesson_type": "mock_exam",
"cards": [...]  // 15 cards (within limits)
```

**Note**: If SOW specifies 25 cards, agent should consolidate related content into fewer, richer cards.

---

### 4. Invalid courseId Format

**Problem**: courseId doesn't start with "course_"

```json
"courseId": "test123"
```

**Error**:
```
field: "courseId"
error: "courseId must start with 'course_'"
```

**Fix**: Add correct prefix
```json
"courseId": "course_test123"
```

---

### 5. Empty outcomeRefs Array

**Problem**: No outcomes specified

```json
"outcomeRefs": []
```

**Error**:
```
field: "outcomeRefs"
error: "ensure this value has at least 1 items"
```

**Fix**: Add at least one outcome
```json
"outcomeRefs": ["O1", "AS1.2"]
```

---

### 6. Non-Sequential Card Numbers

**Problem**: Card numbers have gaps or duplicates

```json
"cards": [
  {"card_number": 1, ...},
  {"card_number": 3, ...},  // Gap: skipped 2
  {"card_number": 4, ...}
]
```

**Error**:
```
field: "cards"
error: "Card numbers must be sequential starting from 1. Expected card_number 2, got 3"
```

**Fix**: Make sequential
```json
"cards": [
  {"card_number": 1, ...},
  {"card_number": 2, ...},
  {"card_number": 3, ...}
]
```

---

### 7. Wrong CFU Field Name (CRITICAL - v2.0.0)

**Problem**: Using `cfu_type` instead of `type`

```json
"cfu": {
  "cfu_type": "mcq",  // WRONG field name
  "id": "q001",
  "stem": "Which fraction equals 0.5?",
  ...
}
```

**Error**:
```
field: "cards.0.cfu"
error: "cfu object must contain 'type' field"
```

**Fix**: Use `type` field (not `cfu_type`)
```json
"cfu": {
  "type": "mcq",  // CORRECT field name
  "id": "q001",
  "stem": "Which fraction equals 0.5?",
  ...
}
```

---

### 8. Missing CFU Required Fields (NEW in v2.0.0)

**Problem**: MCQ missing `answerIndex` field

```json
"cfu": {
  "type": "mcq",
  "id": "q001",
  "stem": "Which fraction equals 0.5?",
  "options": ["1/4", "1/2", "1/3", "2/4"]
  // Missing answerIndex!
}
```

**Error**:
```
field: "cards.0.cfu.answerIndex"
error: "Field required"
```

**Fix**: Add required field
```json
"cfu": {
  "type": "mcq",
  "id": "q001",
  "stem": "Which fraction equals 0.5?",
  "options": ["1/4", "1/2", "1/3", "2/4"],
  "answerIndex": 1,  // ADDED
  "rubric": {...}
}
```

---

### 9. Rubric Sum Mismatch (NEW in v2.0.0)

**Problem**: Criteria points don't sum to total_points

```json
"rubric": {
  "total_points": 3,
  "criteria": [
    {"description": "Correct answer", "points": 1},
    {"description": "Shows working", "points": 1}
    // Sum is 2, but total_points is 3!
  ]
}
```

**Error**:
```
field: "rubric.criteria"
error: "Sum of criteria points (2.0) does not equal total_points (3.0)"
```

**Fix**: Ensure sum matches
```json
"rubric": {
  "total_points": 3,
  "criteria": [
    {"description": "Correct answer", "points": 1},
    {"description": "Shows working", "points": 1},
    {"description": "Uses units", "points": 1}  // ADDED to match total
  ]
}
```

## Testing

### Run Example

```bash
cd examples
python example_validation_tool.py
```

This will demonstrate:
1. Valid template validation
2. JSON syntax error handling
3. Schema validation error handling

### Manual Testing

```python
from claude_agent_sdk import query, ClaudeAgentOptions
from src.tools.json_validator_tool import validation_server

options = ClaudeAgentOptions(
    mcp_servers={"validator": validation_server},
    allowed_tools=["mcp__validator__validate_lesson_template"],
    permission_mode='acceptEdits'
)

prompt = "Validate lesson_template.json using the validation tool"

async for message in query(prompt=prompt, options=options):
    if hasattr(message, 'content'):
        for block in message.content:
            if hasattr(block, 'text'):
                print(block.text)
```

## Integration with Lesson Authoring Pipeline

### Lesson Author Agent (Step 4.5)

After writing `lesson_template.json`:
1. ✅ Call validation tool
2. ✅ If valid: Proceed to critic review
3. ❌ If invalid: Fix errors using Edit tool, re-validate

### Lesson Critic Agent (Step 0)

Before quality evaluation:
1. ✅ Call validation tool
2. ✅ If valid: Proceed with dimensional scoring
3. ❌ If invalid: Write critic_result.json with validation errors, STOP

## Benefits (v2.0.0)

1. **Fast Fail**: Catches errors immediately after writing
2. **Detailed Errors**: Pydantic provides field-level error messages with field paths
3. **Self-Correction**: Agents can read errors and fix issues autonomously
4. **No Fallbacks**: Follows anti-pattern guidelines - fails explicitly
5. **Type Safety**: Pydantic ensures runtime type checking
6. **Token Savings**: Avoids critic evaluation of invalid files
7. **Prevents Inline Comments**: The inline comment bug (line 288) is caught immediately
8. **Deep CFU Validation** (NEW): Type-specific validation ensures MCQ has answerIndex, numeric has expected/tolerance, etc.
9. **Rubric Validation** (NEW): Ensures criteria points sum to total_points
10. **Misconception Validation** (NEW): Validates ID format and content length
11. **Correct Schema** (NEW): Validates OUTPUT schema (not SOW input schema)
12. **Comprehensive Coverage** (NEW): 37 unit tests covering all edge cases

## Future Enhancements

1. Add validation for SOW schemas
2. Add validation for `critic_result.json`
3. Create generic `validate_json_schema` tool with configurable models
4. Add warnings for non-blocking issues (e.g., "title too short but acceptable")
5. Add statistics (field coverage, common error patterns)
6. Add validation for optional fields (accessibility_profile, coherence, etc.)

## Related Documentation

- [Lesson Template Schema](../schema/lesson_template_schema.md)
- [Custom Tools Guide](custom-tools.md)
- [Python SDK Documentation](python_sdk_docs.md)

## Support

For issues or questions:
- Check error messages and fix_suggestions in validation response
- Review common errors section above
- Run example: `python examples/example_validation_tool.py`
- Check lesson_template_schema.md for field requirements
