# SOW Seeding Infrastructure - Technical Documentation

> **Comprehensive guide to the Scheme of Work (SOW) seeding system**
> Last Updated: October 2025

## 📋 Table of Contents

- [Overview](#overview)
- [Quick Start](#quick-start)
- [Prerequisites](#prerequisites)
- [File Structure](#file-structure)
- [Seeding Workflow](#seeding-workflow)
- [Documentation Index](#documentation-index)
- [Common Use Cases](#common-use-cases)

## Overview

The SOW Seeding Infrastructure is a TypeScript-based system for populating the Appwrite database with Scheme of Work (SOW) data generated by the `sow_author_agent`. It manages the complex relationships between course outcomes, lesson templates, and authored SOW entries while maintaining referential integrity across the database.

### Key Features

- **4-Phase Validation Pipeline**: Ensures data quality before and after seeding
- **Deterministic Upsert Pattern**: Prevents duplicate data with stable ID lookups
- **Outcome Reference Mapping**: Automatically resolves outcome IDs to document references
- **Template Placeholder Creation**: Pre-creates lesson template records for future lesson authoring
- **Comprehensive Error Reporting**: Detailed validation messages with actionable fixes

### Architecture Overview

```
Data Flow:
  1. SQA Education Data (sqa_education.sqa_current collection)
       ↓
  2. SOW Author Agent → sow_authored_*.json
       ↓
  3. seedAuthoredSOW.ts → AUTO-POPULATES → course_outcomes
       ↓
  4. seedAuthoredSOW.ts → Authored_SOW + lesson_templates (placeholders)
       ↓
  5. seedAuthoredLesson.ts (PRODUCTION READY) → Lesson Author Agent → lesson_templates (populated)
```

**Note**: Steps 1, 3, and 4 now happen automatically within seedAuthoredSOW.ts using preparatory phases.

## Quick Start

### Run SOW Seeding

```bash
# From assistant-ui-frontend directory
npm run seed:authored-sow
```

This single command executes the full seeding pipeline for the current SOW data file (`sow_authored_AOM_nat3.json`).

### Expected Output

```
🌱 Starting Authored_SOW seed script...

✅ Environment variables validated
✅ Admin client created with API key authentication
✅ ServerAuthoredSOWDriver initialized

🔍 Validating outcome references...
  ✅ O1: Analyse an everyday situation involving money
  ✅ O2: Carry out calculations involving money
  ✅ All 12 outcome references validated

📝 Creating lesson template placeholders...
  ✅ Created #1: Introduction to Numeracy Skills (6745abc...)
  ✅ Updated #2: Check-in: Notation and Units (6745def...)
  ...

📊 Template Creation Summary:
   Created: 45
   Updated: 3
   Total: 48

💾 Upserting to Authored_SOW collection...
✅ Successfully seeded Authored_SOW!
   Document ID: 6745xyz...
   Entries stored: 48 lessons

🎉 Seed script completed successfully!
```

## Prerequisites

### 1. Environment Variables

Create `.env.local` in `assistant-ui-frontend/`:

```env
NEXT_PUBLIC_APPWRITE_ENDPOINT=https://cloud.appwrite.io/v1
NEXT_PUBLIC_APPWRITE_PROJECT_ID=your_project_id
APPWRITE_API_KEY=your_admin_api_key  # Required for seeding
```

⚠️ **IMPORTANT**: `APPWRITE_API_KEY` must be an admin API key with full database permissions.

### 2. SQA Course Data (Required)

**NEW**: The `course_outcomes` collection is now **automatically populated** by seedAuthoredSOW.ts.

You only need to ensure SQA course data exists in the `sqa_education.sqa_current` collection.

**Manual migration (optional)**:
```bash
# Only needed if you want to manually pre-populate outcomes
tsx scripts/migrateCourseOutcomes.ts course_c84473
```

The seeding script will:
- **PHASE -2**: Auto-extract outcomes from SQA if not already extracted
- **PHASE -1**: Auto-populate course_outcomes if not already populated
- Skip these phases if data already exists (idempotent)

### 3. SOW Data File

Ensure the SOW JSON file exists:
```
langgraph-author-agent/data/sow_authored_AOM_nat3.json
```

This file is generated by the `sow_author_agent` LangGraph agent.

### 4. Dependencies

```bash
# Install dependencies
npm install --legacy-peer-deps
```

Required packages:
- `node-appwrite`
- `tsx` (for TypeScript execution)
- `dotenv`

## File Structure

```
ScottishAILessons/
├── langgraph-author-agent/
│   ├── data/
│   │   ├── sow_authored_AOM_nat3.json          # SOW data input
│   │   ├── course_outcomes_import.json          # Outcomes reference
│   │   └── research_pack_json_AOM_nat3.txt      # Resource pack (future)
│   └── docs/
│       └── Seeding/                             # This documentation
│           ├── README.md                        # ← You are here
│           ├── architecture.md                  # System design
│           ├── seeding-scripts-reference.md     # Script details
│           ├── database-schema.md               # Collections & fields
│           ├── step-by-step-guide.md            # Execution walkthrough
│           └── troubleshooting.md               # Error solutions
│
└── assistant-ui-frontend/
    ├── scripts/
    │   ├── seedAuthoredSOW.ts                   # Main seeding script ★
    │   ├── migrateCourseOutcomes.ts             # Outcome migration
    │   ├── seed-clean-data.ts                   # Deprecated
    │   └── (future) seedAuthoredLesson.ts       # Lesson authoring integration
    ├── __tests__/support/
    │   └── ServerAuthoredSOWDriver.ts           # Server-side driver
    └── lib/appwrite/
        ├── driver/
        │   ├── BaseDriver.ts                    # Base driver class
        │   ├── AuthoredSOWDriver.ts             # Client-side driver
        │   └── LessonDriver.ts                  # Lesson operations
        └── types/
            └── index.ts                         # TypeScript interfaces
```

## Seeding Workflow

### Phase 0: Outcome Reference Validation

Validates that all `outcomeRefs` in SOW entries exist in `course_outcomes` collection.

**Why**: Prevents seeding invalid foreign key references.

```typescript
// Validates: ["O1", "O2", "O3"]
await validateOutcomeReferences(databases, sowData.entries, courseId);
```

### Phase 1: Lesson Template Placeholders

Creates empty lesson template records with outcome references mapped to real document IDs.

**Why**: Establishes deterministic IDs for future lesson authoring agent to populate.

```typescript
// Creates/updates lesson_templates with:
// - courseId + sow_order (deterministic lookup)
// - Real outcome document IDs (not "O1", but "6745abc...")
// - Empty cards array (populated later)
const referenceMap = await createOrUpdateLessonTemplates(...);
```

### Phase 2: SOW Entry Updates

Replaces placeholder template IDs (`AUTO_TBD_1`) with real document IDs.

**Why**: Links SOW entries to actual lesson template documents.

```typescript
// Transforms:
// lessonTemplateRef: "AUTO_TBD_1" → "6745abc123def..."
const updatedEntries = await updateEntriesWithTemplateRefs(...);
```

### Phase 3: Authored_SOW Upsert

Inserts or updates the Authored_SOW document with all enriched data.

**Why**: Stores complete SOW with validated references.

```typescript
// Upserts with courseId + version lookup
const result = await sowDriver.upsertAuthoredSOW(authoredSOWData);
```

### Phase 4: Validation

Performs 3-tier validation on the seeded data.

**Why**: Ensures referential integrity across all collections.

```
✅ Uniqueness Check: All 48 template IDs are unique
✅ Existence Check: All 48 templates exist in database
✅ Title Matching: All titles match perfectly
```

## Documentation Index

| Document | Purpose | Key Content |
|----------|---------|-------------|
| **[architecture.md](./architecture.md)** | System design & patterns | Data model, relationships, design decisions |
| **[seeding-scripts-reference.md](./seeding-scripts-reference.md)** | Script API reference | Function signatures, parameters, examples |
| **[database-schema.md](./database-schema.md)** | Database structure | Collection fields, JSON stringification, indexes |
| **[step-by-step-guide.md](./step-by-step-guide.md)** | Detailed walkthrough | Phase-by-phase execution with code snippets |
| **[troubleshooting.md](./troubleshooting.md)** | Error solutions | Common errors, fixes, debugging tips |

## Common Use Cases

### 1. First-Time Setup (Single Course)

```bash
# Just run seeding - auto-populates everything!
npm run seed:authored-sow

# The script automatically:
# - Creates course document if missing
# - Extracts outcomes from SQA database
# - Populates course_outcomes collection
# - Creates lesson template placeholders
# - Seeds Authored_SOW
```

### 2. Batch Processing (Multiple Courses)

```bash
# Process all SOW files in Seeding_Data/input/sows/
tsx scripts/seedAuthoredSOW.ts --batch --input-dir /path/to/Seeding_Data

# Validation-only mode (dry run)
tsx scripts/seedAuthoredSOW.ts --batch --validate --input-dir /path/to/Seeding_Data

# Generates report: Seeding_Data/output/reports/batch-report-{timestamp}.json
```

**Directory Structure**:
```
Seeding_Data/
├── input/sows/
│   ├── mathematics_national-4.json
│   ├── application-of-mathematics_national-3.json
│   └── ... (other SOW files)
└── output/
    ├── course_outcomes_imports/  (auto-generated)
    ├── logs/                      (auto-generated)
    └── reports/                   (auto-generated)
```

### 3. Update Existing SOW

```bash
# Just re-run seeding (upsert handles updates)
npm run seed:authored-sow
```

The script will:
- Update existing lesson templates (matched by `sow_order`)
- Update Authored_SOW document (matched by `courseId` + `version`)

### 4. Generate Lesson Content (Production Ready)

```bash
# Step 1: Create SOW structure
npm run seed:authored-sow

# Step 2: Generate AI lesson content for specific entry
npm run seed:authored-lesson course_c84774 0 ../langgraph-author-agent/data/research_pack_json_AOM_nat3.txt

# Step 3: Repeat for all entries (or use batch script)
npm run seed:authored-lesson course_c84774 1 ../langgraph-author-agent/data/research_pack_json_AOM_nat3.txt
```

**Features**:
- ✅ Automatic error recovery (max 10 retries)
- ✅ Thread persistence for human-in-the-loop
- ✅ Triple JSON input (SOW entry + resource pack + metadata)
- ✅ Card compression (60-80% size reduction)
- ✅ Comprehensive logging

### 5. Validate Data Integrity

```bash
# Re-run seeding with verbose output
npm run seed:authored-sow 2>&1 | tee seeding-output.log

# Check for validation warnings/errors
grep "❌\|⚠️" seeding-output.log
```

## Key Concepts

### Deterministic Upsert Pattern

**Problem**: Running seeding scripts multiple times creates duplicate data.

**Solution**: Use stable, deterministic lookup keys for upsert logic.

```typescript
// Lesson Templates: courseId + sow_order (stable even if title changes)
Query.equal('courseId', courseId),
Query.equal('sow_order', entry.order)

// Authored_SOW: courseId + version
Query.equal('courseId', courseId),
Query.equal('version', version)
```

### JSON Stringification

**Why**: Appwrite stores complex objects as JSON strings.

**Where**:
- `Authored_SOW.entries` - Array of SOW entries
- `Authored_SOW.metadata` - Metadata object
- `lesson_templates.outcomeRefs` - Array of outcome document IDs
- `lesson_templates.cards` - Array of lesson cards

**Example**:
```typescript
// Writing
const templateData = {
  outcomeRefs: JSON.stringify(["6745abc...", "6745def..."]),
  cards: JSON.stringify([...])
};

// Reading
const outcomeRefs = JSON.parse(template.outcomeRefs);
```

### Outcome ID Mapping

**Problem**: SOW data uses logical IDs (`"O1"`, `"O2"`), but database uses document IDs (`"6745abc..."`).

**Solution**: Map logical IDs to document IDs during template creation.

```typescript
// Input: ["O1", "O2"]
// Query course_outcomes for documents with outcomeId="O1", "O2"
// Output: ["6745abc123def...", "6745xyz789ghi..."]
const documentIds = await mapOutcomeIdsToDocumentIds(databases, outcomeIds, courseId);
```

## Next Steps

- **New Developer**: Start with [architecture.md](./architecture.md) to understand the system design
- **Running Scripts**: Follow [step-by-step-guide.md](./step-by-step-guide.md) for detailed execution instructions
- **Debugging Errors**: Check [troubleshooting.md](./troubleshooting.md) for common issues and solutions
- **Extending System**: Review [seeding-scripts-reference.md](./seeding-scripts-reference.md) for script patterns

## Related Documentation

- **Lesson Author Agent**: `../README_LESSON_AUTHOR.md` - Agent that generates lesson content
- **SOW Author Agent**: `../README_SOW_AUTHOR.md` - Agent that generates SOW data
- **Outcome Migration**: `../../data/OUTCOME_MIGRATION_GUIDE.md` - SQA outcome data migration
- **Database Schema**: `../../assistant-ui-frontend/lib/appwrite/types/index.ts` - TypeScript types

## Contributing

When modifying seeding scripts:
1. Update validation logic to maintain referential integrity
2. Add error messages with actionable fixes
3. Update this documentation with new patterns
4. Test with both new and existing data

---

**Questions or Issues?**
Contact: Scottish AI Lessons Development Team
