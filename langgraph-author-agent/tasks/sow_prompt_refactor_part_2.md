# SoW Prompt Refactor Part 2: Purely Generative Prompts

## Status
**Completed** | Created: 2025-10-13 | Completed: 2025-10-13 | Supersedes: Initial enrichment-aware prompt updates

## Problem Statement

The current SoW author prompts contain references to the enrichment pipeline and post-processing steps. This violates the principle of **separation of concerns** - the LLM should be completely agnostic to what happens after generation.

### Issues with Current Approach

1. **Enrichment Pipeline Awareness**: Prompts mention "enrichment pipeline will add metadata fields"
2. **Technical Implementation Details**: Schema includes NOTE comments about post-processing
3. **Mixed Concerns**: Instructions mix pedagogical generation with technical pipeline details
4. **Confusing Language**: Fields marked "optional (enrichment generates)" conflate optionality with post-processing

### Examples of Problematic Content

```
- `authored_sow_json`: SoW pedagogical content (enrichment pipeline will add metadata fields).
  * OPTIONAL: $id, version, status, timestamps (enrichment will add if missing)
  * DO NOT include: lessonTemplateRef (enrichment generates from order field)
```

```json
{
  "$id": "string, optional (enrichment generates)",
  "courseId": "string, REQUIRED - must match Course_data.txt (e.g., 'course_c84473')",
  "version": "int, optional (enrichment defaults to 1)",
  // NOTE: lessonTemplateRef NOT generated by AI - enrichment creates "AUTO_TBD_1" from order field
}
```

## Goals

1. **Pure Generative Focus**: Prompts describe only what the AI must produce
2. **Zero Post-Processing Awareness**: No mentions of enrichment, pipelines, or post-processing
3. **Clear Field Requirements**: REQUIRED vs optional based on AI generation, not pipeline behavior
4. **Pedagogical Clarity**: Emphasize educational decision-making over technical field management

## Refactoring Principles

### Principle 1: Describe Output, Not Processing

**❌ BEFORE (Pipeline-Aware)**:
```
enrichment will add full descriptions to eliminate downstream lookups
```

**✅ AFTER (Generative-Focused)**:
```
Use assessment standard codes from Course_data.txt (e.g., "AS1.2")
```

### Principle 2: Remove Technical NOTEs

**❌ BEFORE**:
```json
{
  "order": 1,
  // NOTE: lessonTemplateRef NOT generated by AI - enrichment creates "AUTO_TBD_1" from order field
  "label": "Percents from Fractions",
}
```

**✅ AFTER**:
```json
{
  "order": 1,
  "label": "Percents from Fractions",
}
```

### Principle 3: Field Requirements Based on Generation

**❌ BEFORE**:
```
"$id": "string, optional (enrichment generates)"
```

**✅ AFTER**:
```
"$id": "string, optional - can be omitted"
```

### Principle 4: Focus on Pedagogical Purpose

**❌ BEFORE**:
```
- **CRITICAL: Always set `order` field** - this is required for lessonTemplateRef generation and sequencing.
```

**✅ AFTER**:
```
- **CRITICAL: Sequential ordering** - Always set `order` field (1, 2, 3...) to establish lesson prerequisite relationships
```

## Detailed Changes

### Section 1: Output Descriptions (SOW_AGENT_PROMPT)

**Location**: `sow_author_prompts.py:111-125`

**CURRENT**:
```xml
<outputs>
You MUST write these flat files (state["files"]["<name>"] = <json/string>):
- `authored_sow_json`                    : SoW pedagogical content (enrichment pipeline will add metadata fields).
  * MUST include: courseId (for validation)
  * MUST include: entries[] with pedagogical content (order, label, lesson_type, coherence, policy, engagement_tags, outcomeRefs, assessmentStandardRefs, pedagogical_blocks, accessibility_profile, estMinutes, notes)
  * OPTIONAL: $id, version, status, timestamps (enrichment will add if missing)
  * DO NOT include: lessonTemplateRef (enrichment generates from order field)
  * DO NOT include: coherence.unit (enrichment derives from outcomeRefs using Course_data.txt)
</outputs>
```

**PROPOSED**:
```xml
<outputs>
You MUST write these flat files (state["files"]["<name>"] = <json/string>):
- `authored_sow_json`                    : Complete SoW with pedagogical content and metadata.
  * REQUIRED: courseId, metadata (coherence, accessibility_notes, engagement_notes), entries[]
  * Each entry REQUIRED: order, label, lesson_type, coherence, policy, engagement_tags, outcomeRefs, assessmentStandardRefs, estMinutes
  * Each entry OPTIONAL: pedagogical_blocks, accessibility_profile, notes
  * Top-level OPTIONAL: $id, version, status, timestamps
  * Entry-level OPTIONAL: lessonTemplateRef
</outputs>
```

### Section 2: Schema Documentation (SOW_AGENT_PROMPT)

**Location**: `sow_author_prompts.py:223-296`

**CURRENT**:
```json
{
  "$id": "string, optional (enrichment generates)",
  "courseId": "string, REQUIRED - must match Course_data.txt (e.g., 'course_c84473')",
  "version": "int, optional (enrichment defaults to 1)",
  "status": "string, optional (enrichment defaults to 'draft')",

  "metadata": { ... },

  "entries": [
    {
      "order": 1,
      // NOTE: lessonTemplateRef NOT generated by AI - enrichment creates "AUTO_TBD_1" from order field
      "label": "Percents from Fractions",

      "coherence": {
        // NOTE: coherence.unit NOT generated by AI - enrichment derives from outcomeRefs using Course_data.txt
        "block_name": "Percents",
        ...
      },

      "assessmentStandardRefs": ["AS1.2"],     // REQUIRED: Assessment Standard codes (enrichment will add full descriptions).
      ...
    }
  ]

  // NOTE: createdAt/updatedAt NOT generated by AI - enrichment adds timestamps
}
```

**PROPOSED**:
```json
{
  "courseId": "string, REQUIRED - course identifier from Course_data.txt",

  "metadata": {
    "coherence": {
      "policy_notes": ["REQUIRED: Strategic calculator usage sequencing (e.g., 'Non-calc first; calc later')"],
      "sequencing_notes": ["REQUIRED: Curriculum flow rationale (e.g., 'Fractions → Decimals → Percents')"]
    },
    "accessibility_notes": ["REQUIRED: Global accessibility strategies (plain language, pacing, chunking)"],
    "engagement_notes": ["REQUIRED: Scottish context hooks (£ prices, NHS, supermarket flyers, bus fares)"],
    "weeks": "int, optional - planned teaching weeks",
    "periods_per_week": "int, optional - periods per week"
  },

  "entries": [
    {
      "order": "int, REQUIRED - sequential position establishing lesson order (1, 2, 3...)",
      "label": "string, REQUIRED - teacher-facing lesson title",
      "lesson_type": "string, REQUIRED - teach | independent_practice | formative_assessment | mock_assessment | summative_assessment | project | revision | spiral_revisit",

      "coherence": {
        "block_name": "string, REQUIRED - sub-topic label within the unit",
        "block_index": "string, REQUIRED - ordering indicator for visual transparency (e.g., '2.1', '2.2')",
        "prerequisites": ["optional - references to earlier lessons by order or label"]
      },

      "policy": {
        "calculator_section": "string, REQUIRED - non_calc | mixed | calc (aligns with SQA assessment model)",
        "assessment_notes": "string, optional - clarifications for marking or re-assessment"
      },

      "engagement_tags": ["REQUIRED - Scottish context tags: shopping, bus_fares, NHS, sports, finance, etc."],

      "outcomeRefs": ["REQUIRED - outcome codes from Course_data.txt (e.g., 'O1', 'O2')"],
      "assessmentStandardRefs": ["REQUIRED - assessment standard codes from Course_data.txt (e.g., 'AS1.2', 'AS2.1')"],

      "pedagogical_blocks": ["optional - lesson structure hints: starter, modelling, guided_practice, independent_practice, exit_ticket"],

      "accessibility_profile": {
        "dyslexia_friendly": "boolean, optional - emphasize dyslexia-friendly design",
        "plain_language_level": "string, optional - target reading level (e.g., 'CEFR_B1')",
        "extra_time": "boolean, optional - flag for extended time provision"
      },

      "estMinutes": "int, REQUIRED - estimated duration (25-50 minutes typical for Scottish periods)",
      "notes": "string, optional - teacher guidance not shown to students"
    }
  ]
}
```

### Section 3: Workflow Instructions (SOW_AUTHOR_SUBAGENT_PROMPT)

**Location**: `sow_author_prompts.py:666-687`

**CURRENT**:
```xml
5. **Draft a new SoW JSON** focusing on pedagogical content:
   - Specify courseId from Course_data.txt (for validation)
   - CRITICAL: Set `order` field for each entry (prerequisite sequencing)
   - Use outcomeRefs and assessmentStandardRefs (codes only - enrichment will add full descriptions)
   - Focus on lesson_type, label, policy, coherence (block_name, block_index, prerequisites), engagement_tags, pedagogical_blocks, accessibility_profile, estMinutes, notes
   - Enrichment pipeline will add: $id, version, status, timestamps, lessonTemplateRef, coherence.unit
   - Follow `recommended_sequence` globally and ensure within-standard cadence is realistic.
   - Incorporate engagement hooks and accessibility notes from the research pack.
```

**PROPOSED**:
```xml
5. **Draft a complete SoW JSON** with pedagogical decisions:
   - Specify courseId from Course_data.txt to identify the course
   - For each lesson entry, set sequential `order` field (1, 2, 3...) to establish prerequisite relationships
   - Use outcomeRefs and assessmentStandardRefs codes from Course_data.txt
   - Make pedagogical decisions for each lesson:
     * lesson_type (teach, practice, assessment, revision)
     * label (clear, teacher-facing title)
     * policy (calculator usage, assessment notes)
     * coherence (block_name, block_index, prerequisites)
     * engagement_tags (authentic Scottish contexts)
   - Include accessibility considerations (accessibility_profile) and duration estimates (estMinutes)
   - Follow Course_data.txt `recommended_sequence` for unit ordering
   - Ensure within-standard lesson cadence is realistic (teach → formative → practice → revision)
   - Incorporate Scottish engagement hooks and accessibility strategies from research pack
```

### Section 4: Constraints (SOW_AUTHOR_SUBAGENT_PROMPT)

**Location**: `sow_author_prompts.py:773-785`

**CURRENT**:
```xml
<constraints>
- Always ground decisions in the research pack (exemplars, contexts, policies) and `Course_data.txt`.
- **For every assessment standard, create a multi-lesson sequence** covering the required lesson types; avoid collapsing multiple standards into a single lesson unless pedagogically justified.
- **Focus on pedagogical content only** - metadata will be added by enrichment pipeline.
- **CRITICAL: Always set `order` field** - this is required for lessonTemplateRef generation and sequencing.
- **Use codes for assessmentStandardRefs** - enrichment will add full descriptions to eliminate downstream lookups.
- **Do NOT generate**: $id, version, status, createdAt, updatedAt, lessonTemplateRef, coherence.unit
- **DO generate**: All fields requiring educational judgment (order, label, lesson_type, policy, coherence.block_name, coherence.block_index, coherence.prerequisites, engagement_tags, outcomeRefs, assessmentStandardRefs, pedagogical_blocks, accessibility_profile, estMinutes, notes)
- Write valid JSON only (no comments).
- Do not omit required pedagogical fields.
- Do not self-reference ("I drafted…").
- If critic feedback files are present, incorporate and revise before finalising.
</constraints>
```

**PROPOSED**:
```xml
<constraints>
- Always ground decisions in the research pack (exemplars, contexts, policies) and `Course_data.txt`.
- **For every assessment standard, create a multi-lesson sequence** covering the required lesson types; avoid collapsing multiple standards into a single lesson unless pedagogically justified.
- **Focus on pedagogical decision-making**: What lessons to teach, in what order, with what pedagogical approach, using which Scottish contexts.
- **CRITICAL: Sequential ordering** - Always set `order` field (1, 2, 3...) to establish clear lesson sequence and prerequisite relationships.
- **Use official codes** - Reference outcomeRefs and assessmentStandardRefs using codes from Course_data.txt (e.g., "O1", "AS1.2").
- **Required fields**: courseId, metadata (coherence.policy_notes, coherence.sequencing_notes, accessibility_notes, engagement_notes), entries with order, label, lesson_type, coherence, policy, engagement_tags, outcomeRefs, assessmentStandardRefs, estMinutes.
- **Optional fields**: You may omit or include: $id, version, status, timestamps, lessonTemplateRef, pedagogical_blocks, accessibility_profile, notes.
- Write valid JSON only (no comments or self-references).
- If critic feedback files are present, incorporate and revise before finalising.
</constraints>
```

## Implementation Checklist

### Phase 1: Create Specification
- [x] Document refactoring approach in `sow_prompt_refactor_part_2.md`
- [x] Identify all enrichment references in current prompts
- [x] Define pure generative alternatives
- [x] Get user approval on plan

### Phase 2: Update SOW_AGENT_PROMPT (Lines 3-360)
- [x] Update `<outputs>` section (lines 111-125) - remove enrichment references
- [x] Update `<schema_sow_with_field_descriptions>` (lines 223-296) - pure generative format
- [x] Remove all enrichment-related language
- [x] Remove all NOTE comments about post-processing
- [x] Make courseId optional (seeding script injection)

### Phase 3: Update SOW_AUTHOR_SUBAGENT_PROMPT (Lines 627-799)
- [x] Update `<workflow>` section (lines 666-687) - remove enrichment mentions
- [x] Update `<schema>` section (lines 695-755) - pure generative format
- [x] Update `<constraints>` section (lines 773-785) - focus on pedagogical decisions
- [x] Remove all enrichment-related language
- [x] Remove all NOTE comments about post-processing

### Phase 4: Validation
- [x] Search for "enrichment" in prompts (should find 0 matches)
- [x] Search for "pipeline" in prompts (should find 0 matches)
- [x] Search for "NOTE:" in schema sections (should find 0 matches)
- [x] Verify all field descriptions focus on pedagogical purpose
- [x] Verify optional fields clearly marked without technical explanations

## Implementation Summary

**Completion Date**: 2025-10-13

All phases completed successfully. The SoW author prompts have been fully refactored to achieve pure generative focus with zero post-processing awareness.

### Key Changes Implemented

1. **SOW_AGENT_PROMPT Updates**:
   - Removed all enrichment pipeline references from `<outputs>` section
   - Converted schema to pure generative format (no technical NOTEs)
   - Made courseId optional (seeding script handles injection via CLI argument)
   - Removed references to lessonTemplateRef, $id, version, status, timestamps

2. **SOW_AUTHOR_SUBAGENT_PROMPT Updates**:
   - Rewritten `<workflow>` section to focus on pedagogical decisions
   - Converted `<schema>` section to pure generative format
   - Updated `<constraints>` to emphasize educational judgment, not technical field management
   - Removed all enrichment-related language

3. **Validation Results**:
   - `grep -i "enrichment"` → 0 matches ✅
   - `grep -i "pipeline"` → 0 matches ✅
   - `grep "// NOTE:"` → 0 matches ✅

### Files Modified

- **Specification**: `langgraph-author-agent/tasks/sow_prompt_refactor_part_2.md` (this file)
- **Implementation**: `langgraph-author-agent/src/sow_author_prompts.py`
  - Lines 111-125: `<outputs>` section
  - Lines 223-296: `<schema_sow_with_field_descriptions>` section
  - Lines 645-672: SOW_AUTHOR_SUBAGENT_PROMPT `<workflow>` section
  - Lines 680-732: SOW_AUTHOR_SUBAGENT_PROMPT `<schema>` section
  - Lines 749-759: SOW_AUTHOR_SUBAGENT_PROMPT `<constraints>` section

### Architectural Impact

**Before**: LLM was aware of enrichment pipeline and generated metadata fields
**After**: LLM focuses 100% on pedagogical decisions, seeding script handles all metadata

**Integration Point**: `assistant-ui-frontend/scripts/seedAuthoredSOW.ts` receives courseId as CLI argument (line 43) and injects all metadata during post-processing.

## Success Criteria

- ✅ **Zero enrichment references**: No mentions of "enrichment" anywhere in prompts
- ✅ **Zero pipeline references**: No mentions of "pipeline" anywhere in prompts
- ✅ **Zero technical NOTEs**: No `// NOTE:` comments about post-processing
- ✅ **Pure generative focus**: Schema describes what AI produces, not what happens later
- ✅ **Pedagogical clarity**: Constraints emphasize educational decision-making
- ✅ **Clear optionality**: Optional fields marked without technical implementation details

## Expected Benefits

1. **Reduced Prompt Complexity**: Simpler instructions focusing only on generation
2. **Better Separation of Concerns**: LLM focuses on pedagogy, pipeline handles boilerplate
3. **Improved Maintainability**: Prompt changes don't require understanding pipeline
4. **Clearer Expectations**: What AI must produce vs what's optional
5. **Future-Proof**: Prompts independent of pipeline implementation changes

## Related Specifications

- **Original Refactor**: `sow_prompt-refactor.md` - Pre-populated research pack pattern
- **Enrichment Pipeline**: `sow-seeding-enrichment-spec.md` - TypeScript seeding script (separate concern)
- **Prompt Enrichment**: `sow-prompt-enrichment-spec.md` - Field classification (AI vs pipeline)

---

**Document Owner**: AI Analysis | **Status**: Completed | **Last Updated**: 2025-10-13 | **Completed**: 2025-10-13
