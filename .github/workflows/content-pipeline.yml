# Content Authoring Pipeline - GitHub Actions Workflow
#
# This workflow enables running the content authoring pipeline via GitHub Actions.
# It can be triggered manually with subject/level parameters or via API.
#
# Usage:
#   1. Go to Actions tab in GitHub
#   2. Select "Content Authoring Pipeline"
#   3. Click "Run workflow"
#   4. Enter subject and level
#
# API Trigger:
#   curl -X POST \
#     -H "Accept: application/vnd.github.v3+json" \
#     -H "Authorization: token $GITHUB_TOKEN" \
#     https://api.github.com/repos/OWNER/REPO/actions/workflows/content-pipeline.yml/dispatches \
#     -d '{"ref":"main","inputs":{"subject":"mathematics","level":"national_5"}}'

name: Content Authoring Pipeline

on:
  workflow_dispatch:
    inputs:
      subject:
        description: 'SQA Subject (e.g., mathematics, physics, chemistry)'
        required: true
        type: string
      level:
        description: 'SQA Level (e.g., national_5, higher, advanced_higher)'
        required: true
        type: string
      skip_diagrams:
        description: 'Skip diagram generation step'
        required: false
        type: boolean
        default: false
      force:
        description: 'Force regenerate existing content'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run mode (no actual execution)'
        required: false
        type: boolean
        default: false

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT }}
  APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
  APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
  LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
  LANGSMITH_TRACING: 'true'
  LANGSMITH_PROJECT: 'scottish-ai-lessons-pipeline'

jobs:
  validate:
    name: Validate Inputs
    runs-on: ubuntu-latest
    outputs:
      subject: ${{ steps.validate.outputs.subject }}
      level: ${{ steps.validate.outputs.level }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate Subject and Level
        id: validate
        run: |
          cd devops
          python3 -c "
          from lib.validators import validate_subject_level
          subject, level = validate_subject_level('${{ inputs.subject }}', '${{ inputs.level }}')
          print(f'Validated: {subject} / {level}')
          " || (echo 'Invalid subject or level' && exit 1)

          echo "subject=${{ inputs.subject }}" >> $GITHUB_OUTPUT
          echo "level=${{ inputs.level }}" >> $GITHUB_OUTPUT

  run-pipeline:
    name: Run Content Pipeline
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 480  # 8 hours max for full course generation

    services:
      # Diagram screenshot service for Step 4
      diagram-screenshot:
        image: ghcr.io/schoolofai/diagram-screenshot:latest
        ports:
          - 3001:3000
        env:
          API_KEY: ${{ secrets.DIAGRAM_API_KEY }}
        options: >-
          --health-cmd "curl -f http://localhost:3000/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: assistant-ui-frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: claud_author_agent/requirements.txt

      - name: Install Frontend Dependencies
        working-directory: assistant-ui-frontend
        run: npm ci --legacy-peer-deps

      - name: Install Python Dependencies
        working-directory: claud_author_agent
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -e .
          pip install aiohttp  # For diagram service health checks

      - name: Wait for Diagram Service
        if: ${{ !inputs.skip_diagrams }}
        run: |
          echo "Waiting for diagram screenshot service..."
          for i in {1..30}; do
            if curl -s http://localhost:3001/health > /dev/null; then
              echo "Diagram service is ready!"
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          echo "Warning: Diagram service may not be ready"

      - name: Generate Run ID
        id: run_id
        run: echo "run_id=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: Run Pipeline
        id: pipeline
        run: |
          source claud_author_agent/.venv/bin/activate

          # Build command
          CMD="python devops/pipeline_runner.py lessons"
          CMD="$CMD --subject ${{ inputs.subject }}"
          CMD="$CMD --level ${{ inputs.level }}"

          if [ "${{ inputs.skip_diagrams }}" = "true" ]; then
            CMD="$CMD --skip-diagrams"
          fi

          if [ "${{ inputs.force }}" = "true" ]; then
            CMD="$CMD --force"
          fi

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "Running: $CMD"
          $CMD

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pipeline-reports-${{ steps.run_id.outputs.run_id }}
          path: devops/reports/
          retention-days: 30

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pipeline-logs-${{ steps.run_id.outputs.run_id }}
          path: devops/logs/
          retention-days: 7

      - name: Upload Checkpoints
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pipeline-checkpoints-${{ steps.run_id.outputs.run_id }}
          path: devops/checkpoints/
          retention-days: 30

      - name: Post Summary
        if: always()
        run: |
          echo "## Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find the latest run directory
          RUN_ID=$(ls -t devops/reports/ 2>/dev/null | head -1)

          if [ -z "$RUN_ID" ]; then
            echo "No reports generated." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          SUMMARY_FILE="devops/reports/$RUN_ID/summary.json"

          if [ -f "$SUMMARY_FILE" ]; then
            # Parse summary with Python for better JSON handling
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          import sys

          try:
              with open("$SUMMARY_FILE") as f:
                  data = json.load(f)

              success = data.get("success", False)
              status_icon = "✅" if success else "❌"
              status_text = "Success" if success else "Failed"

              print(f"**Status:** {status_icon} {status_text}")
              print("")
              print(f"- **Run ID:** `{data.get('run_id', 'N/A')}`")
              print(f"- **Subject:** {data.get('subject', 'N/A')}")
              print(f"- **Level:** {data.get('level', 'N/A')}")
              print(f"- **Course ID:** `{data.get('course_id', 'N/A')}`")
              print(f"- **Steps Completed:** {data.get('steps_completed', 0)}/4")
              print(f"- **Total Cost:** ${data.get('total_cost_usd', 0):.2f}")
              print(f"- **Total Tokens:** {data.get('total_tokens', 0):,}")

              if data.get("error"):
                  print("")
                  print(f"**Error:** {data.get('error')}")
          except Exception as e:
              print(f"Error parsing summary: {e}")
          EOF
          else
            echo "Summary file not found." >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: run-pipeline
    if: always()
    steps:
      - name: Notify on Success
        if: ${{ needs.run-pipeline.result == 'success' }}
        run: |
          echo "Pipeline completed successfully for ${{ inputs.subject }} / ${{ inputs.level }}"
          # Add Slack/Discord notification here if needed

      - name: Notify on Failure
        if: ${{ needs.run-pipeline.result == 'failure' }}
        run: |
          echo "Pipeline failed for ${{ inputs.subject }} / ${{ inputs.level }}"
          # Add Slack/Discord notification here if needed
