# Implementation Plan: Revision Notes Frontend Integration

**Branch**: `003-revision-notes-frontend` | **Date**: 2025-11-10 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-revision-notes-frontend/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

This feature integrates revision notes (course cheat sheets and lesson quick notes) into the frontend UI, enabling students to access exam preparation materials from the dashboard and during active lesson sessions.

**Primary Requirement**: Display markdown-based revision notes with LaTeX math notation and Mermaid diagrams in accessible modals and collapsible side panels.

**Technical Approach**:
- Use **react-markdown** with remark-math/rehype-katex for LaTeX rendering and rehype-mermaid for diagrams
- Use **Radix UI Dialog** for accessible modals with ARIA compliance
- Implement **modal-based caching** (fetch on open, clear on close) for dashboard views
- Implement **session-scoped caching** (persist for lesson duration) for in-lesson side panel
- Follow **fast-fail principles** (no fallbacks, detailed error messages with retry)
- Ensure **mutual exclusivity** between Lesson Notes and Context Chat side panels

---

## Technical Context

**Language/Version**: TypeScript 5.3+ / React 18+ / Next.js 14+ (existing project stack)

**Primary Dependencies**:
- **react-markdown** (^9.0.1) - CommonMark renderer with plugin ecosystem
- **remark-math** (^6.0.0) + **rehype-katex** (^7.0.0) - LaTeX math rendering
- **rehype-mermaid** (^2.1.0) + **mermaid** (^10.6.1) - Diagram rendering
- **@radix-ui/react-dialog** (existing) - Accessible modal primitives
- **Appwrite SDK** (existing) - Database and storage access

**Storage**: Appwrite Storage (`documents` bucket for markdown files) + Appwrite Database (`revision_notes` collection for metadata)

**Testing**:
- Manual testing with **Playwright MCP tool** (constitution requirement)
- React Testing Library for component unit tests (optional but recommended)
- Test credentials: `test@scottishailessons.com` / `red12345`

**Target Platform**: Web browser (Chrome 90+, Firefox 88+, Safari 14+) - desktop and mobile responsive

**Project Type**: Web application (frontend-only changes, backend exists from spec 002)

**Performance Goals**:
- Course cheat sheet loads in <5 seconds (FR-SC-001)
- Lesson quick notes load in <3 seconds (FR-SC-002)
- Markdown rendering maintains >30 FPS during scroll (FR-SC-008)
- Side panel resize maintains >30 FPS (FR-SC-008)

**Constraints**:
- Bundle size impact <200KB gzipped (markdown renderer stack = ~150KB)
- Mobile-responsive (readable font sizes, scrollable diagrams) (FR-018)
- Lazy load files >5MB to prevent UI freezing (FR-019)
- No persistent caching (all in-memory, cleared on modal close / session end) (FR-020)

**Scale/Scope**:
- Expected courses: 10-50 (Scottish Qualifications Authority curriculum)
- Expected lessons per course: 10-80
- Typical cheat sheet size: 50-200 KB
- Typical lesson notes size: 20-100 KB
- Concurrent users: 100-1000 students

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with `.specify/memory/constitution.md`:

- [x] **Fast-Fail**: No fallback mechanisms planned - all errors throw exceptions with logging
  - RevisionNotesDriver throws detailed exceptions (FILE_NOT_FOUND, FETCH_FAILED, STORAGE_UNAVAILABLE)
  - Error UI displays detailed messages with retry buttons (no silent fallbacks)
  - Malformed markdown syntax handled gracefully (display error blocks, continue rendering)

- [x] **Code Quality**: Design respects 500-line file / 50-line function limits (plan refactoring if needed)
  - MarkdownRenderer component: ~150 lines (within limit)
  - RevisionNotesDriver: ~250 lines (within limit)
  - Hooks extracted into separate file (~300 lines total, 3 hooks)
  - Modal components: ~100-150 lines each (within limit)
  - Helper utilities extracted when functions exceed 50 lines

- [x] **Documentation**: PRD, brief, task updates included in "done" definition
  - research.md documents all technical decisions
  - data-model.md defines entities and state management
  - quickstart.md provides developer onboarding
  - contracts/ defines TypeScript interfaces for all components

- [x] **Testing**: Playwright test strategy defined for manual validation
  - quickstart.md includes detailed Playwright test scenarios
  - Test covers all 3 user stories (P1: course cheat sheet, P2: lesson notes, P3: side panel)
  - Edge cases tested (file not found, network errors, malformed syntax)

- [x] **Architecture**: Compatible with dual implementation (LangGraph + Aegra) if backend changes involved
  - Frontend-only feature (no backend changes required)
  - Uses existing Appwrite infrastructure (database + storage)
  - Backend revision notes system already deployed (spec 002)

**Violations Requiring Justification**: None

---

## Project Structure

### Documentation (this feature)

```
specs/003-revision-notes-frontend/
├── plan.md                      # This file (/speckit.plan command output)
├── research.md                  # Phase 0 output (markdown renderer, modal library, caching strategy)
├── data-model.md                # Phase 1 output (6 core entities, state management)
├── quickstart.md                # Phase 1 output (developer onboarding guide)
├── contracts/                   # Phase 1 output (TypeScript interfaces)
│   ├── RevisionNotesDriver.ts   # Appwrite driver interface
│   ├── RevisionNotesHooks.ts    # React hooks interfaces
│   └── RevisionNotesComponents.ts # Component prop interfaces
└── tasks.md                     # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

This feature uses **Option 2: Web application** structure (frontend changes only).

```
assistant-ui-frontend/
├── components/
│   ├── revision-notes/                           # NEW: Revision notes components (11 components)
│   │   ├── MarkdownRenderer.tsx                   # Core markdown renderer with LaTeX + Mermaid
│   │   ├── CourseCheatSheetModal.tsx              # Course-level cheat sheet modal
│   │   ├── LessonQuickNotesModal.tsx              # Lesson-level notes modal
│   │   ├── LessonNotesSidePanel.tsx               # In-lesson side panel
│   │   ├── RevisionNotesLoadingSkeleton.tsx       # Structured skeleton UI
│   │   ├── RevisionNotesErrorDisplay.tsx          # Error UI with retry
│   │   ├── CourseCheatSheetButton.tsx             # Dashboard course button
│   │   ├── LessonQuickNotesButton.tsx             # Dashboard lesson button
│   │   ├── LessonNotesToggleButton.tsx            # Session toggle button
│   │   ├── LargeFileDownloadFallback.tsx          # >5MB file fallback UI
│   │   ├── SidePanelResizeHandle.tsx              # Shared resize handle
│   │   └── RevisionNotesAvailabilityBadge.tsx     # Availability indicator
│   ├── dashboard/
│   │   └── StudentDashboard.tsx                   # MODIFIED: Add cheat sheet button to course header
│   ├── SessionChatAssistant.tsx                   # MODIFIED: Add lesson notes side panel integration
│   └── [existing components...]
├── lib/
│   └── appwrite/
│       └── driver/
│           └── RevisionNotesDriver.ts              # NEW: Appwrite driver for markdown fetching
├── hooks/
│   └── useRevisionNotes.ts                        # NEW: React hooks (exports 3 hooks)
├── app/
│   ├── layout.tsx                                 # MODIFIED: Import katex.min.css globally
│   └── [existing pages...]
└── package.json                                    # MODIFIED: Add markdown renderer dependencies
```

**Structure Decision**: Web application structure selected because:
1. Frontend-only feature (no backend code in this spec)
2. Existing project uses Next.js app router with components/ directory
3. Backend revision notes system already exists (spec 002)
4. Integration points: StudentDashboard (dashboard/) and SessionChatAssistant (components/)

**Key Integration Points**:
- `StudentDashboard.tsx`: Add course cheat sheet button to course tab header
- `CourseCurriculum.tsx` (or similar): Add lesson notes button to lesson list items
- `SessionChatAssistant.tsx`: Add lesson notes side panel with mutual exclusivity logic

---

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

No violations detected. All constitution principles satisfied:
- Fast-fail error handling throughout
- All components under 500 lines, functions under 50 lines
- Documentation artifacts generated (research, data-model, quickstart, contracts)
- Playwright testing strategy defined in quickstart.md
- Frontend-only changes, compatible with dual backend architecture

---

## Phase 0: Research Summary

**Status**: ✅ Completed

All technical unknowns resolved in `research.md`:

1. **Markdown Renderer**: react-markdown + remark-math + rehype-katex + rehype-mermaid
2. **Modal Library**: Radix UI Dialog (accessible, headless, already in project)
3. **Caching Strategy**: Fetch on open, cache in memory, clear on close (session-scoped for side panel)
4. **Loading State**: Skeleton UI matching markdown structure
5. **Retry Mechanism**: Unlimited user-triggered with exponential backoff hints (3+ rapid retries)
6. **Side Panel Pattern**: Mutual exclusivity with ContextChat, shared resize hook
7. **Storage Integration**: Appwrite Storage SDK (same pattern as DiagramDriver)
8. **Responsive Design**: Mobile-first Tailwind classes, adaptive Mermaid scaling
9. **Large File Handling**: Virtualized rendering or download fallback for >5MB files
10. **Error Handling**: Graceful degradation with visual error indicators (no crashes)

---

## Phase 1: Design Artifacts Summary

**Status**: ✅ Completed

### Data Model (`data-model.md`)

**6 Core Entities**:
1. **RevisionNoteDisplay**: UI component state (courseId, noteType, markdownContent, renderingStatus)
2. **MarkdownRenderer**: Configuration and capabilities (supportsLaTeX, supportsMermaid, error handlers)
3. **SidePanelState**: Side panel state management (activeSidePanel, panelWidth, isResizing)
4. **RevisionNotesCache**: Frontend caching layer (modal-based vs session-scoped)
5. **RevisionNotesLoadingState**: Skeleton UI configuration (headingCount, paragraphBlocks, hasCodeBlocks)
6. **RevisionNotesErrorState**: Error states and retry logic (error codes, retry count, backoff hint)

**State Management Patterns**:
- Modal state: React useState with cache lifecycle hooks
- Side panel state: React useState + useRef for session-scoped cache
- Mutual exclusivity: Enum-based state machine (ActiveSidePanel)

### API Contracts (`contracts/`)

**3 Contract Files**:

1. **RevisionNotesDriver.ts** (~250 lines):
   - `getCourseCheatSheet(courseId)`: Fetch course-level cheat sheet
   - `getLessonQuickNotes(courseId, lessonOrder)`: Fetch lesson-level notes
   - `courseCheatSheetExists(courseId)`: Availability check
   - `lessonNotesExist(courseId, lessonOrder)`: Availability check
   - Custom error class: RevisionNotesError with error codes

2. **RevisionNotesHooks.ts** (~300 lines):
   - `useCourseCheatSheet()`: Modal lifecycle hook
   - `useLessonQuickNotes()`: Modal lifecycle hook
   - `useLessonNotesSidePanel()`: Session-scoped side panel hook

3. **RevisionNotesComponents.ts** (~300 lines):
   - TypeScript interfaces for all 11 components
   - Prop definitions with JSDoc examples
   - Component file map for implementation planning

### Quickstart Guide (`quickstart.md`)

**7-Phase Implementation Workflow**:
1. Core Markdown Renderer (1-2 hours)
2. Appwrite Driver (1 hour)
3. React Hooks (1-2 hours)
4. Modal Components (2-3 hours)
5. Dashboard Integration (1 hour)
6. Lesson List Integration (1 hour)
7. SessionChatAssistant Side Panel (2-3 hours)

**Total Estimated Time**: 10-15 hours

**Manual Testing Strategy**:
- Playwright MCP tool test scenarios
- Test credentials: test@scottishailessons.com / red12345
- 3 major flows: course cheat sheet, lesson notes, side panel

---

## Phase 2: Next Steps

**Command**: `/speckit.tasks`

This will generate `tasks.md` with:
- Dependency-ordered implementation tasks
- Independent test scenarios per task
- Acceptance criteria per user story
- Technical debt tracking (if any)

**Post-Implementation**:
1. Run manual Playwright tests per quickstart.md
2. Update `.specify/memory/agent-context-claude.md` (already done via script)
3. Code review for constitution compliance
4. Create PR when all tests pass

---

## Implementation Notes

### Critical Dependencies
- Backend revision notes must be generated (spec 002) BEFORE frontend can display them
- Verify at least one course has cheat sheet + lesson notes in Appwrite before testing
- Markdown files must exist in Appwrite Storage `documents` bucket

### Performance Optimizations
- Skeleton UI reduces perceived latency by 30-40%
- In-memory caching avoids repeated network requests during single viewing session
- Session-scoped cache (side panel) persists across panel toggles for better UX

### Accessibility Considerations
- Radix UI Dialog provides ARIA-compliant modals with focus management
- Keyboard navigation supported (Esc to close, Tab to navigate)
- Screen reader compatible (semantic HTML, proper heading hierarchy)

### Mobile Responsive Strategy
- Tailwind responsive classes: `text-base md:text-lg` for typography
- Full-screen modals on mobile: `inset-0 md:inset-10`
- Adaptive Mermaid diagrams: `useMaxWidth: true` configuration
- Horizontal scroll for large code blocks

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Backend revision notes not generated | High - feature unusable | Verify backend deployment before frontend work |
| Markdown renderer bundle size | Medium - slow load times | Lazy load react-markdown on first modal open |
| Malformed markdown crashes UI | High - poor UX | Graceful error handling (display error blocks, continue rendering) |
| Large files freeze browser | Medium - poor UX | >5MB files trigger download fallback (FR-019) |
| Cache stale content | Low - confusing UX | Clear cache on modal close (modal) / session end (side panel) |

---

## Success Metrics

From spec success criteria:

- **SC-001**: Course cheat sheet loads in <5 seconds ✅ (research validates network + render time)
- **SC-002**: Lesson notes load in <3 seconds ✅ (smaller files, same architecture)
- **SC-003**: 100% LaTeX + Mermaid rendering success ✅ (battle-tested libraries)
- **SC-006**: 100% detailed error messages ✅ (RevisionNotesError with error codes)
- **SC-007**: 100% graceful malformed syntax handling ✅ (error callbacks, no crashes)
- **SC-008**: >30 FPS resize performance ✅ (CSS transforms, no layout thrashing)

User-facing metrics (post-launch):
- **SC-004**: 85% students rate "helpful for exam preparation" (survey)
- **SC-009**: 95% mobile accessibility (testing across devices)
- **SC-010**: 25% reduction in exam prep time (time tracking + surveys)

---

## Appendix: Document ID Format

Per spec 002, revision notes use these document ID formats:

**Course Cheat Sheet**:
```
revision_notes_{courseId}_cheat_sheet
```

**Lesson Quick Notes**:
```
revision_notes_{courseId}_lesson_{lessonOrder:02d}
```

Examples:
- `revision_notes_nat3_app_maths_cheat_sheet`
- `revision_notes_nat3_app_maths_lesson_01`
- `revision_notes_nat3_app_maths_lesson_15`

**Validation Pattern** (TypeScript):
```typescript
const cheatSheetPattern = /^revision_notes_[\w-]+_cheat_sheet$/;
const lessonNotePattern = /^revision_notes_[\w-]+_lesson_\d{2}$/;
```

---

**End of Plan** | Generated by `/speckit.plan` | Next: Run `/speckit.tasks` to generate actionable task list
