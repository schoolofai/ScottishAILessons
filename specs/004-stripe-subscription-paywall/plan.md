# Implementation Plan: Stripe Subscription Paywall for AI Features

**Branch**: `004-stripe-subscription-paywall` | **Date**: 2025-11-14 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-stripe-subscription-paywall/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Integrate Stripe subscription payments to gate access to AI-powered teaching features (langgraph-agent and langgraph-generic-chat backends). Non-paying users cannot use costly AI metered backends. Access enforcement occurs at two points: EnhancedStudentDashboard (lesson start) and SessionChatAssistant (AI tutor access). Test users bypass all subscription checks. Implementation uses Next.js API routes for Stripe integration, Appwrite database for subscription metadata, and webhook-driven state synchronization with immediate revocation on payment failures (no grace period).

## Technical Context

**Language/Version**: TypeScript 5.x (Next.js 14+), Node.js 18+
**Primary Dependencies**:
- `stripe` (v14.x) - Stripe Node.js SDK
- `@stripe/stripe-js` (v2.x) - Stripe frontend SDK
- `node-appwrite` (v11.x) - Appwrite server SDK
- `swr` (v2.x) - Data fetching for subscription status
- Next.js 14+ App Router

**Storage**: Appwrite Cloud (existing) - 5 collections (1 extended, 4 new)
**Testing**: Playwright (manual testing), Stripe CLI (webhook testing)
**Target Platform**: Web (Next.js deployed on Vercel/similar)
**Project Type**: Web application (frontend-only changes, backend agnostic)
**Performance Goals**:
- Subscription status check: <50ms p95
- Checkout session creation: <200ms p95
- Webhook processing: <2 seconds p95
**Constraints**:
- No caching of subscription status (security-critical)
- Immediate access revocation on payment failure (no grace period)
- Manual admin intervention for failed webhooks (no automatic retries)
**Scale/Scope**:
- Expected users: 500-1,000 active subscriptions
- Webhook events: ~50-100/day
- Checkout sessions: ~10-20/day

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with `.specify/memory/constitution.md`:

- [x] **Fast-Fail**: All API routes throw exceptions on failure. Webhook errors are queued for manual intervention, not silently ignored. No fallback mechanisms for subscription status checks.
- [x] **Code Quality**: API routes estimated at 100-150 lines each (under 500). Helper functions will be extracted to `/lib/stripe-helpers.ts` for signature verification and event processing (keeping functions under 50 lines).
- [x] **Documentation**: research.md, data-model.md, contracts/, quickstart.md all created. tasks.md will be generated in next phase.
- [x] **Testing**: Playwright test strategy defined in research.md Section 9. Manual testing checklist included in quickstart.md Section 8.
- [x] **Architecture**: Frontend-only implementation. Compatible with both LangGraph and Aegra backends (no backend changes required).

**Violations Requiring Justification**: None

## Project Structure

### Documentation (this feature)

```
specs/004-stripe-subscription-paywall/
├── plan.md                                      # This file (implementation plan)
├── research.md                                  # Stripe API patterns, webhook security, database design
├── data-model.md                                # Complete database schema (5 collections)
├── quickstart.md                                # Step-by-step Stripe setup guide
├── checklists/
│   └── requirements.md                          # Specification quality validation
├── contracts/
│   ├── 01-create-checkout-session.md           # POST /api/stripe/checkout
│   ├── 02-webhook-handler.md                   # POST /api/stripe/webhook
│   ├── 03-subscription-status.md               # GET /api/stripe/subscription-status
│   ├── 04-create-portal-session.md             # POST /api/stripe/portal
│   ├── 05-admin-failed-webhooks.md             # GET /api/admin/failed-webhooks
│   └── 06-admin-resolve-webhook.md             # PATCH /api/admin/failed-webhooks/:id
└── tasks.md                                     # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```
assistant-ui-frontend/                           # Frontend (Next.js 14+ App Router)
├── app/
│   ├── api/
│   │   ├── stripe/
│   │   │   ├── checkout/
│   │   │   │   └── route.ts                    # Create checkout session API
│   │   │   ├── webhook/
│   │   │   │   └── route.ts                    # Webhook event handler API
│   │   │   ├── portal/
│   │   │   │   └── route.ts                    # Create portal session API
│   │   │   └── subscription-status/
│   │   │       └── route.ts                    # Get subscription status API
│   │   └── admin/
│   │       └── failed-webhooks/
│   │           ├── route.ts                    # List failed webhooks API
│   │           └── [errorId]/
│   │               └── route.ts                # Resolve webhook error API
│   ├── dashboard/
│   │   └── page.tsx                            # Dashboard page (modified)
│   └── settings/
│       └── page.tsx                            # User settings (new/modified)
├── components/
│   ├── dashboard/
│   │   ├── EnhancedStudentDashboard.tsx        # Modified: Add subscription check
│   │   ├── SubscriptionPaywallModal.tsx        # NEW: Paywall modal
│   │   └── SubscriptionStatusBanner.tsx        # NEW: Payment failed banner
│   ├── chat/
│   │   └── SessionChatAssistant.tsx            # Modified: Add subscription check
│   ├── subscription/
│   │   ├── ManageSubscriptionButton.tsx        # NEW: Customer portal button
│   │   └── SubscriptionStatusCard.tsx          # NEW: Status display component
│   └── admin/
│       ├── AdminFailedWebhooksTable.tsx        # NEW: Failed webhooks dashboard
│       └── ResolveWebhookModal.tsx             # NEW: Manual resolution UI
├── lib/
│   ├── stripe-helpers.ts                       # NEW: Stripe utility functions
│   ├── subscription-helpers.ts                 # NEW: Access control utilities
│   └── appwrite-config.ts                      # Modified: Add collection IDs
├── hooks/
│   └── useSubscription.ts                      # NEW: Subscription status hook
└── .env.local                                  # Modified: Add Stripe config
    .env.production                             # Modified: Add Stripe config (production)

langgraph-agent/                                 # NO CHANGES (backend agnostic)
langgraph-generic-chat/                          # NO CHANGES (backend agnostic)
aegra-agent/                                     # NO CHANGES (backend agnostic)
```

**Structure Decision**:

This is a **web application** (Option 2), but with **frontend-only changes**. All Stripe integration logic resides in the Next.js frontend (`assistant-ui-frontend/`) using API routes. The existing backends (langgraph-agent, langgraph-generic-chat, aegra-agent) remain unchanged, maintaining compatibility with the dual implementation strategy.

**Key Architectural Decisions**:
1. **API Routes in Next.js**: Stripe integration uses Next.js 14+ App Router API routes (`app/api/stripe/`) instead of a separate backend service.
2. **Appwrite for State**: Subscription metadata is stored in Appwrite database (extending existing users collection and adding 4 new collections).
3. **Webhook-Driven Updates**: Subscription status changes are triggered by Stripe webhooks, not API polling.
4. **Access Control at Frontend**: Subscription checks occur in React components (`EnhancedStudentDashboard`, `SessionChatAssistant`) before calling backend services.

## Implementation Phases

### Phase 0: Planning & Research ✅ COMPLETE

**Duration**: 1 day (completed 2025-11-14)

**Deliverables**:
- [x] research.md - Stripe API integration patterns
- [x] data-model.md - Database schema design
- [x] contracts/ - 6 API endpoint specifications
- [x] quickstart.md - Stripe setup guide
- [x] plan.md - This implementation plan

**Outcome**: Comprehensive planning artifacts ready for implementation.

---

### Phase 1: Core Infrastructure (3-4 days)

**Goal**: Set up Stripe integration foundation and database schema

#### Task 1.1: Extend Appwrite Database Schema (1 day)

**Appwrite Console Actions**:
1. Extend `users` collection with 5 new attributes:
   - `subscriptionStatus` (enum: inactive, active, payment_failed, cancelled)
   - `stripeCustomerId` (string, nullable)
   - `stripeSubscriptionId` (string, nullable)
   - `testUserFlag` (boolean, default: false)
   - `subscriptionExpiresAt` (datetime, nullable)
2. Create `subscriptions` collection with 12 attributes
3. Create `subscription_audit_logs` collection (immutable)
4. Create `stripe_webhook_events` collection (idempotency)
5. Create `webhook_error_queue` collection (manual intervention)
6. Create indexes for performance-critical queries
7. Configure permissions for each collection

**Reference**: [data-model.md](./data-model.md) Section "Migration Strategy"

#### Task 1.2: Install Stripe SDK and Dependencies (0.5 days)

```bash
cd assistant-ui-frontend
npm install --save stripe @stripe/stripe-js swr
npm install --save-dev @types/stripe
```

**Environment Configuration**:
- Copy `.env.example` to `.env.local`
- Add Stripe test mode keys (get from Stripe Dashboard)
- Configure Stripe CLI for local webhook testing

**Reference**: [quickstart.md](./quickstart.md) Steps 1-4

#### Task 1.3: Create Next.js API Routes Foundation (1-2 days)

**Files to Create**:
1. `app/api/stripe/checkout/route.ts` - Checkout session creation
2. `app/api/stripe/webhook/route.ts` - Webhook event handler
3. `app/api/stripe/portal/route.ts` - Customer portal session
4. `app/api/stripe/subscription-status/route.ts` - Subscription status check

**Helper Libraries**:
5. `lib/stripe-helpers.ts`:
   - `verifyWebhookSignature(body, signature, secret)`
   - `createStripeClient(apiKey)`
   - `extractUserIdFromCheckoutSession(session)`

6. `lib/appwrite-server.ts` (extend existing):
   - `createSessionClient(request)` (use existing)
   - Add collection ID constants

**Constitution Compliance**:
- Each route file: <150 lines (extract helpers to `lib/`)
- Helper functions: <50 lines each
- Fast-fail error handling: All errors throw exceptions with detailed logging

**Reference**: [contracts/](./contracts/) for API specifications

#### Task 1.4: Test Database Migration and API Routes (0.5 days)

**Manual Testing**:
- Create test user in Appwrite
- Call checkout API route (should create session)
- Verify Stripe CLI captures webhook
- Check database records are created correctly

**Reference**: [quickstart.md](./quickstart.md) Section 8

---

### Phase 2: Access Control & Paywall UI (2-3 days)

**Goal**: Implement subscription checks and paywall modal

#### Task 2.1: Create useSubscription Hook (0.5 days)

**File**: `hooks/useSubscription.ts`

**Functionality**:
- Fetch subscription status using SWR (no caching)
- Return: `{ status, hasAccess, isLoading, error, refetch }`
- Handle authentication errors gracefully

**Reference**: [contracts/03-subscription-status.md](./contracts/03-subscription-status.md) Section "Frontend Integration"

#### Task 2.2: Build Paywall Modal Component (1 day)

**File**: `components/dashboard/SubscriptionPaywallModal.tsx`

**Features**:
- Display subscription benefits
- "Subscribe Now" button (calls checkout API)
- Redirect to Stripe Checkout on success
- Error handling with user-friendly messages
- Responsive design

**Constitution**: Component <200 lines (extract sub-components if needed)

#### Task 2.3: Integrate Paywall into EnhancedStudentDashboard (0.5 days)

**File**: `components/dashboard/EnhancedStudentDashboard.tsx` (modify existing)

**Integration Point**: `handleStartLesson` function (line ~758-863)

**Logic**:
```typescript
const { hasAccess, isLoading } = useSubscription();

const handleStartLesson = async (lessonTemplateId: string) => {
  // Check subscription BEFORE starting lesson
  if (!hasAccess) {
    setShowPaywallModal(true);
    return; // STOP - do not proceed
  }

  // Original lesson start logic...
};
```

**Reference**: [spec.md](./spec.md) User Story 2, Acceptance Scenario 1

#### Task 2.4: Integrate Access Check into SessionChatAssistant (0.5 days)

**File**: `components/chat/SessionChatAssistant.tsx` (modify existing)

**Integration Point**: Component mount (after backend check, line ~75-104)

**Logic**:
```typescript
const { hasAccess, status } = useSubscription();

useEffect(() => {
  // Check backend availability first (existing logic)
  checkAllBackendsStatus().then((result) => {
    if (!result.available) return;

    // NEW: Check subscription access
    if (!hasAccess) {
      setError('Subscription required to access AI tutor');
      return;
    }

    // Proceed with session initialization...
  });
}, [hasAccess]);
```

**Reference**: [spec.md](./spec.md) User Story 3, Acceptance Scenario 1

#### Task 2.5: Create Payment Failed Notification Banner (0.5 days)

**File**: `components/subscription/SubscriptionStatusBanner.tsx`

**Functionality**:
- Display in-app banner when `subscriptionStatus === 'payment_failed'`
- Show "Update Payment Method" button (links to Customer Portal)
- Dismissible but reappears on page reload (not permanently dismissed)

**Reference**: [spec.md](./spec.md) FR-045, FR-046

---

### Phase 3: Webhook Processing & Security (2-3 days)

**Goal**: Implement robust webhook handling with idempotency and error recovery

#### Task 3.1: Implement Webhook Signature Verification (0.5 days)

**File**: `app/api/stripe/webhook/route.ts` (enhance)

**Critical Security**:
```typescript
// MUST use raw body text, NOT parsed JSON
const body = await request.text();
const signature = headers().get('stripe-signature');

if (!signature) {
  throw new Error('Missing stripe-signature header');
}

const event = stripe.webhooks.constructEvent(
  body,
  signature,
  process.env.STRIPE_WEBHOOK_SECRET!
);
// Signature verified ✅ - proceed with processing
```

**Reference**: [contracts/02-webhook-handler.md](./contracts/02-webhook-handler.md) Section "Signature Verification"

#### Task 3.2: Implement Idempotency Check (0.5 days)

**Logic** (in webhook handler):
1. Check if `event.id` exists in `stripe_webhook_events` collection
2. If exists → Return 200 OK, skip processing
3. If not exists → Create record with `processingStatus: 'processing'`
4. Process event
5. Update record with `processingStatus: 'completed'`

**Reference**: [data-model.md](./data-model.md) Section "Subscription Activation Flow"

#### Task 3.3: Implement Event Type Handlers (1-2 days)

**Event Handlers** (extract to `lib/stripe-helpers.ts`):

1. `handleCheckoutSessionCompleted(event)`:
   - Extract user ID from `client_reference_id`
   - Update user `subscriptionStatus` to 'active'
   - Create subscription record
   - Create audit log entry

2. `handleInvoicePaymentFailed(event)`:
   - Find user by Stripe customer ID
   - Update `subscriptionStatus` to 'payment_failed'
   - Trigger in-app notification (banner)
   - Send email notification (best-effort)

3. `handleSubscriptionDeleted(event)`:
   - Update `subscriptionStatus` to 'cancelled'
   - Set `subscriptionExpiresAt` to now (immediate revocation)
   - Create audit log entry

4. `handleSubscriptionUpdated(event)`:
   - Update subscription metadata (renewal date, plan changes)
   - Create audit log entry

**Constitution**: Each handler function <50 lines (extract sub-helpers if needed)

**Reference**: [contracts/02-webhook-handler.md](./contracts/02-webhook-handler.md) Section "Event-Specific Handlers"

#### Task 3.4: Implement Error Queue Pattern (0.5 days)

**Logic** (in webhook handler):
```typescript
try {
  await handleEventType(event);
  // Mark webhook as completed
} catch (error) {
  // Add to error queue for manual intervention
  await databases.createDocument(
    DATABASE_ID,
    'webhook_error_queue',
    ID.unique(),
    {
      webhookEventId: event.id,
      errorMessage: error.message,
      retryCount: 0,
      resolutionStatus: 'pending_admin_review'
    }
  );

  // Return 200 to Stripe (prevent infinite retries)
  // Admin will manually reconcile
  return Response.json({ received: true, queued: true });
}
```

**Reference**: [research.md](./research.md) Section 3 "Error Queue Pattern"

---

### Phase 4: Admin Dashboard for Manual Intervention (2 days)

**Goal**: Build admin interface for failed webhook resolution

#### Task 4.1: Create Admin Failed Webhooks API Routes (0.5 days)

**Files**:
1. `app/api/admin/failed-webhooks/route.ts` - List failed webhooks
2. `app/api/admin/failed-webhooks/[errorId]/route.ts` - Resolve webhook error

**Authorization**: Verify user has `admin` role before allowing access

**Reference**: [contracts/05-admin-failed-webhooks.md](./contracts/05-admin-failed-webhooks.md)

#### Task 4.2: Build Admin Dashboard UI (1 day)

**Files**:
1. `components/admin/AdminFailedWebhooksTable.tsx`:
   - Display failed webhooks in table
   - Filter by resolution status
   - Show webhook payload details
   - "Resolve" button per row

2. `components/admin/ResolveWebhookModal.tsx`:
   - Form to mark webhook as 'resolved' or 'ignored'
   - Textarea for admin notes (required, min 10 chars)
   - Submit resolution action

**Page**: `app/admin/webhooks/page.tsx` (new admin-only page)

**Reference**: [contracts/06-admin-resolve-webhook.md](./contracts/06-admin-resolve-webhook.md) Section "Frontend Integration"

#### Task 4.3: Test Manual Intervention Workflow (0.5 days)

**Manual Testing**:
1. Simulate webhook failure (disconnect Appwrite during webhook)
2. Verify error is added to `webhook_error_queue`
3. Login as admin user
4. Navigate to admin dashboard
5. Resolve failed webhook with notes
6. Verify audit log is created
7. Verify webhook status updates to 'resolved'

**Reference**: [quickstart.md](./quickstart.md) Section 9

---

### Phase 5: Test User Management (1 day)

**Goal**: Implement test user auto-flagging and bypass logic

#### Task 5.1: Create Test User Auto-Flagging Script (0.5 days)

**File**: `scripts/flag-test-users.ts` (new)

**Functionality**:
- Query Appwrite users collection for emails ending in `@testuser.com`
- Update `testUserFlag` to `true` for matching users
- Log flagged users for verification

**Run manually**:
```bash
npx tsx scripts/flag-test-users.ts
```

**Reference**: [spec.md](./spec.md) FR-017, FR-018, FR-019

#### Task 5.2: Verify Test User Bypass in Access Control (0.5 days)

**Testing**:
1. Create test user with email `test@testuser.com`
2. Verify `testUserFlag` is `true`
3. Attempt to start lesson (should bypass paywall)
4. Verify subscription status check returns `hasAccess: true` even with `subscriptionStatus: 'inactive'`

**Logic** (already implemented in `useSubscription` hook):
```typescript
const hasAccess = userDoc.testUserFlag || userDoc.subscriptionStatus === 'active';
```

**Reference**: [contracts/03-subscription-status.md](./contracts/03-subscription-status.md) Section "Access Control Decision Flow"

---

### Phase 6: Notification System (1-2 days)

**Goal**: Implement in-app and email notifications for subscription events

#### Task 6.1: Create In-App Notification Banner (0.5 days)

**File**: `components/subscription/SubscriptionStatusBanner.tsx` (extend from Phase 2)

**Display Logic**:
- Payment failed: Red banner with "Update Payment Method" button
- Subscription cancelled: Yellow banner with "Reactivate Subscription" button
- Subscription expiring soon: Blue banner with renewal reminder (future enhancement)

**Integration**: Add to `app/dashboard/layout.tsx` (shows on all dashboard pages)

**Reference**: [spec.md](./spec.md) FR-046

#### Task 6.2: Implement Email Notification Helper (0.5-1 day)

**File**: `lib/email-helpers.ts` (new)

**Functionality**:
- `sendPaymentFailedEmail(userEmail, userName)` - Send payment failure email
- `sendSubscriptionCancelledEmail(userEmail, userName)` - Send cancellation confirmation

**Email Service**: Use Resend, SendGrid, or Postmark (configure in environment)

**Best-Effort Pattern**:
```typescript
try {
  await sendEmail(template, data);
} catch (error) {
  // Log failure but DO NOT throw (best-effort)
  console.error('[Email] Failed to send:', error);
}
```

**Reference**: [spec.md](./spec.md) FR-047, FR-048

#### Task 6.3: Integrate Notifications into Webhook Handlers (0.5 days)

**Modify**: `lib/stripe-helpers.ts` webhook handlers

**Integration Points**:
- `handleInvoicePaymentFailed`: Trigger in-app banner + send email
- `handleSubscriptionDeleted`: Trigger in-app banner + send email

**Reference**: [contracts/02-webhook-handler.md](./contracts/02-webhook-handler.md) Section "Event-Specific Handlers"

---

### Phase 7: Testing & Documentation (2 days)

**Goal**: Comprehensive testing and final documentation updates

#### Task 7.1: Playwright End-to-End Testing (1 day)

**Test Scenarios** (create `tests/subscription-flow.spec.ts`):

1. **Subscription Purchase Flow**:
   - Login as non-subscribed user
   - Attempt to start lesson → Paywall appears
   - Click subscribe → Redirect to Stripe Checkout
   - Complete payment with test card
   - Return to dashboard → Access granted

2. **Failed Payment Flow**:
   - Trigger `invoice.payment_failed` webhook using Stripe CLI
   - Verify user status changes to 'payment_failed'
   - Verify access is revoked
   - Verify in-app banner appears

3. **Test User Bypass**:
   - Login as test user (`@testuser.com`)
   - Attempt to start lesson → No paywall, direct access

4. **Customer Portal**:
   - Login as subscribed user
   - Click "Manage Subscription"
   - Redirect to Stripe Customer Portal
   - Verify portal loads correctly

**Reference**: [research.md](./research.md) Section 9 "Testing Strategy"

#### Task 7.2: Update PRD and Documentation (0.5 days)

**Files to Update**:
- `/specs/004-stripe-subscription-paywall/tasks.md` - Update all tasks to completed
- `README.md` (project root) - Add Stripe setup instructions
- `assistant-ui-frontend/README.md` - Add environment variable documentation

**Reference**: Constitution principle "Documentation-First"

#### Task 7.3: Production Deployment Preparation (0.5 days)

**Checklist**:
- [ ] Complete Stripe account activation
- [ ] Create live products and prices
- [ ] Get live API keys
- [ ] Configure live webhook endpoint in Stripe Dashboard
- [ ] Update `.env.production` with live keys
- [ ] Test with real payment (small amount)
- [ ] Set up monitoring alerts for webhook failures

**Reference**: [quickstart.md](./quickstart.md) Section 7 "Live Mode Activation Checklist"

---

## Risk Assessment

### High-Risk Areas

| Risk | Impact | Mitigation Strategy |
|------|--------|---------------------|
| **Webhook signature verification bypass** | Critical - enables payment spoofing attacks | Mandatory signature verification in code review checklist. No bypass allowed even in development. |
| **Race condition in webhook processing** | High - duplicate subscription records | Idempotency check BEFORE any database writes. Use unique index on eventId. |
| **Stale subscription status cached on frontend** | High - unauthorized access to paid features | Zero caching strategy for subscription status. Always fetch fresh from database. |
| **Database migration fails mid-update** | High - corrupted user records | Test migration on staging environment first. Have rollback script ready. |
| **Stripe API key exposure in code** | Critical - financial fraud | Use environment variables only. Add `.env.local` to `.gitignore`. Code review for hardcoded keys. |

### Medium-Risk Areas

| Risk | Impact | Mitigation Strategy |
|------|--------|---------------------|
| **Webhook endpoint unreachable** | Medium - subscription status out of sync | Error queue for manual intervention. Monitor webhook delivery success rate in Stripe Dashboard. |
| **Test users accidentally charged** | Medium - financial liability | Separate test mode environment. Email domain whitelist (`@testuser.com`) with exact matching only. |
| **Admin dashboard unauthorized access** | Medium - data breach | Role-based access control. Verify admin role on every API request. |
| **Email delivery failure** | Low - poor UX, but not blocking | Best-effort email delivery. Log failures. Primary notification is in-app banner. |

### Low-Risk Areas

| Risk | Impact | Mitigation Strategy |
|------|--------|---------------------|
| **Stripe service downtime** | Low - temporary checkout unavailable | Display user-friendly error message. Retry after Stripe recovers. |
| **Appwrite database slow queries** | Low - slow page load | Indexes on all subscription status queries. Monitor query performance. |

---

## Timeline Estimate

**Total Duration**: 11-15 days (assuming 1 developer full-time)

| Phase | Duration | Dependencies | Completion Criteria |
|-------|----------|--------------|---------------------|
| Phase 0: Planning | 1 day | None | ✅ Complete |
| Phase 1: Infrastructure | 3-4 days | Phase 0 | Database schema migrated, API routes functional, Stripe CLI tested |
| Phase 2: Access Control | 2-3 days | Phase 1 | Paywall modal functional, subscription checks enforce access control |
| Phase 3: Webhooks | 2-3 days | Phase 1 | All 6 webhook event types handled, idempotency verified, error queue working |
| Phase 4: Admin Dashboard | 2 days | Phase 3 | Admins can view and resolve failed webhooks |
| Phase 5: Test Users | 1 day | Phase 2 | Test users bypass subscription checks correctly |
| Phase 6: Notifications | 1-2 days | Phase 3 | In-app banners and emails sent for subscription events |
| Phase 7: Testing & Docs | 2 days | Phases 1-6 | Playwright tests pass, documentation updated, production ready |

**Critical Path**: Phase 1 → Phase 2 → Phase 3 (core functionality)

**Parallel Work Opportunities**:
- Phase 5 (Test Users) can run in parallel with Phase 4 (Admin Dashboard)
- Phase 6 (Notifications) can run in parallel with Phase 4

---

## Next Steps After Plan Approval

1. **Run `/speckit.tasks` command** to break down phases into actionable tasks
2. **Set up development environment**:
   - Create Stripe account
   - Install Stripe CLI
   - Configure `.env.local`
3. **Create feature branch**: `git checkout -b 004-stripe-subscription-paywall`
4. **Begin Phase 1**: Extend Appwrite database schema
5. **Daily progress updates**: Update `tasks.md` with completed tasks

---

## References

- [Specification](./spec.md)
- [Research](./research.md)
- [Data Model](./data-model.md)
- [Quickstart Guide](./quickstart.md)
- [API Contracts](./contracts/)
- [Constitution Principles](../../.specify/memory/constitution.md)
- [Stripe API Documentation](https://stripe.com/docs/api)
- [Next.js App Router](https://nextjs.org/docs/app)
- [Appwrite Database](https://appwrite.io/docs/databases)
