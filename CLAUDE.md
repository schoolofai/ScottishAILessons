# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Development Commands

### Quick Start
```bash
# Official LangGraph
cd langgraph-agent && ./start.sh

# Aegra (self-hosted)
cd aegra-agent && ./start-aegra.sh
```

### LangGraph Agent

#### Development Setup
```bash
cd langgraph-agent
python3 -m venv ../venv
source ../venv/bin/activate
pip install -e . "langgraph-cli[inmem]"
```

#### Running Services
```bash
# Backend (port 2024)
langgraph dev

# Frontend (port 3000)
cd assistant-ui-frontend
npm install --legacy-peer-deps
npm run dev
```

#### Testing
```bash
cd langgraph-agent
pytest tests/
```

### Aegra Agent

#### Development Setup
```bash
cd aegra-agent
uv sync  # or: python3 -m venv .venv && source .venv/bin/activate && pip install -e .
docker compose up postgres -d
source .venv/bin/activate
python3 scripts/migrate.py upgrade
```

#### Running Services
```bash
# Backend (port 8000)
python3 run_server.py
# or with uvicorn:
uv run uvicorn src.agent_server.main:app --reload

# Frontend (port 3001)
cd ../assistant-ui-frontend
PORT=3001 npm run dev
```

#### Testing
```bash
cd aegra-agent
uv run pytest
uv run pytest tests/test_threads_history.py  # Specific test
uv run pytest --cov=src --cov-report=html  # With coverage
```

#### Database Management
```bash
# Apply migrations
python3 scripts/migrate.py upgrade

# Create new migration
python3 scripts/migrate.py revision -m "description"

# Check status
python3 scripts/migrate.py current
```

### Frontend (Shared)

#### Development Commands
```bash
cd assistant-ui-frontend

# Install dependencies
npm install --legacy-peer-deps

# Development server
npm run dev

# Build for production
npm run build

# Linting
npm run lint
```

#### Environment Configuration
The frontend uses different configurations based on the backend:
- `.env.local.langgraph` - LangGraph backend configuration (port 2024, frontend 3000)
- `.env.local.aegra` - Aegra backend configuration (port 8000, frontend 3001)
- `.env.local` - Active configuration (auto-generated by startup scripts)

## High-Level Architecture

### Dual Implementation Strategy
This repository provides two complete LangGraph implementations:

1. **Official LangGraph** (`langgraph-agent/`)
   - Managed cloud service with local development server
   - Uses LangGraph's built-in state management
   - Integrates with LangGraph Studio for visual debugging
   - Simple deployment with minimal configuration

2. **Aegra** (`aegra-agent/`)
   - Self-hosted alternative with PostgreSQL persistence
   - Full control over infrastructure and data
   - Agent Protocol compliant server wrapping LangGraph
   - Docker-based deployment with database migrations

### Shared Components

#### Frontend Architecture (`assistant-ui-frontend/`)
- Single React/Next.js application serves both backends
- Uses `@assistant-ui/react-langgraph` for LangGraph communication
- Environment-based backend switching via `.env.local` templates
- Responsive chat interface with streaming support
- Components: `MyAssistant.tsx` (main chat), `markdown-message.tsx` (rendering)

#### Agent Logic (`agents/`)
- `shared_chat_logic.py` - Core business logic used by both systems
- `langgraph_agent.py` - LangGraph wrapper using add_messages reducer
- `aegra_agent.py` - Aegra wrapper converting AIMessage to AIMessageChunk

### Backend Architecture Differences

#### Official LangGraph
- **Event Protocol**: Uses `event: values` for complete messages
- **Message Types**: Accepts both `AIMessage` and `AIMessageChunk`
- **State Management**: Built-in with LangGraph's StateGraph
- **Graph Definition**: Direct in `src/agent/graph.py`

#### Aegra
- **Event Protocol**: Uses `event: messages` for streaming chunks
- **Message Types**: Requires `AIMessageChunk` for frontend compatibility
- **State Management**: PostgreSQL via LangGraph checkpoint system
- **Graph Loading**: Dynamic from `aegra.json` configuration
- **Database**: Hybrid approach - LangGraph handles state, SQLAlchemy tracks metadata

### Key Integration Points

#### LangGraph SDK Communication
Both systems use the same frontend SDK (`@langchain/langgraph-sdk`) but handle events differently:
- Official: Smart event selection based on message type
- Aegra: Consistent streaming-first approach with AIMessageChunk

#### Authentication Systems
- Official LangGraph: Built-in authentication
- Aegra: Configurable (`AUTH_TYPE=noop` or `AUTH_TYPE=custom`)

#### Database Patterns
- Official: Managed by LangGraph platform
- Aegra: PostgreSQL with Alembic migrations + LangGraph checkpoint tables

## Git Submodule Management

Aegra is managed as a Git submodule (fork at `https://github.com/schoolofai/aegra.git`):

```bash
# Clone with submodules
git clone --recurse-submodules https://github.com/schoolofai/ScottishAILessons.git

# Update submodule
git submodule update --remote aegra-agent

# Work on Aegra customizations
cd aegra-agent
git add . && git commit -m "Changes" && git push
cd ..
git add aegra-agent && git commit -m "Update Aegra submodule"
```

## Project Structure

```
ScottishAILessons/
├── assistant-ui-frontend/       # Shared frontend
│   ├── components/             # React components
│   ├── app/                    # Next.js app router
│   └── .env.local.*           # Environment templates
├── langgraph-agent/            # Official LangGraph
│   ├── src/agent/graph.py     # Graph definition
│   ├── tests/                 # Unit tests
│   └── start.sh              # Startup script
├── aegra-agent/               # Self-hosted (submodule)
│   ├── src/agent_server/      # FastAPI server
│   ├── graphs/                # Agent definitions
│   ├── scripts/migrate.py    # Migration tool
│   └── start-aegra.sh       # Startup script
└── agents/                   # Shared logic
    ├── shared_chat_logic.py
    ├── langgraph_agent.py
    └── aegra_agent.py
```

## Testing Strategy

- Run `pytest` in langgraph-agent for official LangGraph tests
- Run `uv run pytest` in aegra-agent for Aegra tests
- No linting/type checking configured - focus on functional testing
- Both systems support hot-reload during development
- for mvp the test user login details are email - test@scottishailessons.com , password = red12345
- always use playwright mcp tool to mannually test after every code change